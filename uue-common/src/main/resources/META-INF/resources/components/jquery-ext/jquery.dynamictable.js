(function(a){a.widget("ui.dynamictable",{options:{temp:".dynamicRowTemplate",minRows:1,maxRows:50,initAdd:true,afterAdd:false},_create:function(){var b=this;$con=this.element;options=this.options;$temp=$con.find(options.temp);this.tempHtml=$temp.html();$temp.remove();$con.find(" thead tr ").prepend('<th style="width: 30px; text-align: center;">序号</th>');$con.find(" thead tr ").append('<th style="width: 50px; text-align: center;">操作</th>');$con.delegate("i.icon-chevron-up","click",function(){b.addLine(a(this).closest("tr"),"before")});$con.delegate("i.icon-chevron-down","click",function(){b.addLine(a(this).closest("tr"),"after")});$con.delegate("i.icon-minus","click",function(){if($con.find("tbody tr:visible").length==options.minRows){alert("最少要有"+options.minRows+"行！");return false}var d=a(this).closest("tr");var c=d.find("input[name$='.uiOperation']").val();if(c=="update"){d.find("input[name$='.uiOperation']").val("delete");d.hide();d.find(":text,select").not(":hidden").each(function(){a(this).attr("disabled",true)})}else{d.remove()}b.resetIndex()});if(options.initAdd){b.addLine()}return a(this)},addLine:function(d,g){$con=this.element;if($con.find("tbody tr:visible").length==options.maxRows){alert("最多只能添加"+options.maxRows+"行！");return false}var h=a("<tr>"+this.tempHtml+"</tr>");if(d){if(g=="before"){d.before(h)}else{d.after(h)}}else{$con.find("tbody").append(h)}h.find("input,select").each(function(){a(this).removeAttr("id")});var i=a('<td style="text-align: center;" class="row-seq"></td>').prependTo(h);var b=a('<td style="text-align: center;"></td>').appendTo(h);var f=a('<i class="icon-chevron-up" style="cursor:pointer" title="上方添加行项"></i>').appendTo(b);var e=a('<i class="icon-minus" style="cursor:pointer" title="移除当前行项"></i>').appendTo(b);var c=a('<i class="icon-chevron-down" style="cursor:pointer" title="下方添加行项"></i>').appendTo(b);this.resetIndex();if(a.isFunction(options.afterAdd)){options.afterAdd.call($con,h)}},resetIndex:function(){$con=this.element;idx=0;$con.find("tbody tr").each(function(){a(this).find("input,select").each(function(){if(a(this).attr("name")){var b=a(this).attr("name");if(b){a(this).attr("name",b.substring(0,b.indexOf("[")+1)+idx+b.substring(b.indexOf("]"),b.length))}}a(this).removeAttr("id")});idx++});idx=0;$con.find("tbody tr:visible").each(function(){a(this).find("td.row-seq").html(idx+1);idx++});a(this).closest("form").attr("_inputChanged","true")},getVisiableRow:function(){return this.element.find("tr:visible")},destroy:function(){}})})(jQuery);